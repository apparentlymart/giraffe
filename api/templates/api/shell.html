<form id="api-form" class="api-form-GET">

    <div class="span-16 last">
        <div class="span-8">
            <p>
                <select id="api-request-method">
                    <option selected="selected">GET</option>
                    <option>POST</option>
                    <option>PUT</option>
                    <option>DELETE</option>
                </select>
                <input id="api-request-path" value="/api">
            </p>
        </div>
        <div class="span-8 last">
            <p id="api-result-about">&nbsp;</p>
        </div>
    </div>

    <div id="api-request" class="span-16 last">
        <p><textarea id="api-request-body"></textarea></p>
        <p><div id="api-result-body"></div></p>
    </div>

    <div class="span-16 last">
        <p class="buttons"><a id="api-request-button" class="button">Perform awesomeness</a></p>
    </div>

</form>

<script type="text/javascript">
$(document).ready(function () {
    $('#api-request-method').change(function (e) {
        var form = $('#api-form');
        $('#api-request-method option').each(function (i, val) {
            form.removeClass("api-form-" + $(val).val());
        })
        form.addClass("api-form-" + $('#api-request-method option:selected').val());
    });

    function jsonToDom(data) {
        if (null === data) {
            return $('<span/>').addClass('null').text('null');
        }

        if ($.isArray(data)) {
            var result = $('<ol/>');
            $.each(data, function (i, val) {
                var item = $('<li/>');
                item.append(jsonToDom(val));
                result.append(item);
            });
            return result;
        }

        if ('object' == typeof(data)) {
            var result = $('<dl/>');
            $.each(data, function (name, val) {
                var term = $('<dt/>');
                term.text(name);
                result.append(term);

                var dfn = $('<dd/>');
                dfn.append(jsonToDom(val));
                result.append(dfn);
            });
            return result;
        }

        if ('string' == typeof(data)) {
            return $('<span/>').addClass('string').text('"' + data + '"');
        }

        if ('number' == typeof(data)) {
            return $('<span/>').addClass('number').text(data);
        }

        return $('<span/>').addClass('other').text(data);
    }

    $('#api-request-button').click(function (e) {
        var method = $('#api-request-method option:selected').val();
        var path = $('#api-request-path').val();
        var method_has_body = method != "GET" && method != "DELETE";

        $('#api-result-about').addClass('api-result-working');
        $('#api-result-about').text(method + " " + path);
        $('#api-result-body').text("");

        $.ajax({
            dataType: 'text',
            type: method,
            data: (method_has_body ? $('#api-request-body').val() : null),
            contentType: 'application/json',
            processData: false,
            url: path,
            complete: function (xhr, status) {
                $('#api-result-about').removeClass('api-result-working');
                $('#api-result-about').text(method + " " + path);

                if (xhr.status != 200 || xhr.getResponseHeader('Content-Type').indexOf('application/json')) {
                    $('#api-result-body').addClass('text')
                        .text(xhr.responseText);
                    return;
                }

                var result = eval(xhr.responseText);
                $('#api-result-body').removeClass('text')
                    .empty()
                    .append(jsonToDom(result));
            }
        });
    });
});
</script>
